<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yojin Store - Product Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .product-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; }
        .product-name { font-weight: bold; color: #333; margin-bottom: 8px; }
        .product-price { color: #e74c3c; font-size: 1.2em; font-weight: bold; margin-bottom: 8px; }
        .product-category { color: #666; font-size: 0.9em; margin-bottom: 8px; }
        .product-description { color: #777; font-size: 0.9em; }
        .controls { margin-bottom: 20px; }
        .controls input, .controls select, .controls button { padding: 8px; margin-right: 10px; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .error { color: #e74c3c; padding: 10px; background: #fee; border-radius: 4px; margin: 10px 0; }
        .success { color: #27ae60; padding: 10px; background: #efe; border-radius: 4px; margin: 10px 0; }
        .api-toggle { margin-bottom: 20px; padding: 10px; background: #f0f0f0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üè™ Yojin Store - Live Product Integration</h1>
    
    <div class="api-toggle">
        <strong>API Environment:</strong>
        <label><input type="radio" name="apiEnv" value="local" checked> Local (localhost:8080)</label>
        <label><input type="radio" name="apiEnv" value="tunnel"> Tunnel (yummy-seals-battle.loca.lt)</label>
        <button onclick="switchApiEnvironment()">Switch & Test</button>
    </div>
    
    <p><strong>Store:</strong> <span id="store-name">Loading...</span></p>
    <p><strong>API Status:</strong> <span id="api-status">Checking...</span></p>
    <p><strong>Current API:</strong> <span id="current-api">http://localhost:8080</span></p>
    
    <div class="controls">
        <input type="text" id="search-input" placeholder="Search products..." />
        <select id="category-filter">
            <option value="">All Categories</option>
        </select>
        <button onclick="searchProducts()">Search</button>
        <button onclick="loadProducts()">Refresh</button>
    </div>
    
    <div id="loading" class="loading" style="display: none;">Loading products...</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="success" class="success" style="display: none;"></div>
    
    <div id="product-grid" class="product-grid"></div>
    
    <script>
        // Configuration
        const CONFIG = {
            LOCAL_API: 'http://localhost:8080',
            TUNNEL_API: 'https://yummy-seals-battle.loca.lt',
            STORE_ID: '6848451969ae1c9bcb0500da',
            ITEMS_PER_PAGE: 20
        };
        
        let currentApiUrl = CONFIG.LOCAL_API;
        let currentPage = 1;
        let allCategories = [];
        
        // Utility functions
        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }
        
        function switchApiEnvironment() {
            const selectedEnv = document.querySelector('input[name="apiEnv"]:checked').value;
            currentApiUrl = selectedEnv === 'local' ? CONFIG.LOCAL_API : CONFIG.TUNNEL_API;
            document.getElementById('current-api').textContent = currentApiUrl;
            
            // Reset and test new API
            document.getElementById('api-status').innerHTML = 'üîÑ Testing...';
            document.getElementById('store-name').textContent = 'Loading...';
            document.getElementById('product-grid').innerHTML = '';
            
            testApiConnection().then(connected => {
                if (connected) {
                    loadCategories();
                    loadProducts();
                }
            });
        }
        
        // API calls with better error handling
        async function testApiConnection() {
            try {
                const response = await fetch(`${currentApiUrl}/api/v1/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('api-status').innerHTML = '‚úÖ Connected';
                    document.getElementById('api-status').style.color = '#27ae60';
                    showSuccess('API connection successful!');
                    return true;
                } else {
                    throw new Error('API health check failed');
                }
            } catch (error) {
                document.getElementById('api-status').innerHTML = '‚ùå Disconnected';
                document.getElementById('api-status').style.color = '#e74c3c';
                showError(`API connection failed: ${error.message}`);
                return false;
            }
        }
        
        async function loadProducts(page = 1, search = '', category = '') {
            showLoading(true);
            
            try {
                let url = `${currentApiUrl}/api/v1/products?merchant_id=${CONFIG.STORE_ID}&page=${page}&limit=${CONFIG.ITEMS_PER_PAGE}`;
                
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                }
                
                if (category) {
                    url += `&category=${encodeURIComponent(category)}`;
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    displayProducts(data.data.products);
                    document.getElementById('store-name').textContent = data.data.merchant.name;
                    showSuccess(`Loaded ${data.data.products.length} products`);
                } else {
                    throw new Error(data.error || 'Failed to load products');
                }
            } catch (error) {
                showError(`Failed to load products: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        async function loadCategories() {
            try {
                const response = await fetch(`${currentApiUrl}/api/v1/categories?merchant_id=${CONFIG.STORE_ID}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    allCategories = data.data.categories;
                    populateCategoryFilter();
                } else {
                    throw new Error('Failed to load categories');
                }
            } catch (error) {
                showError(`Failed to load categories: ${error.message}`);
            }
        }
        
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('category-filter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            
            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }
        
        function displayProducts(products) {
            const productGrid = document.getElementById('product-grid');
            productGrid.innerHTML = '';
            
            if (products.length === 0) {
                productGrid.innerHTML = '<p>No products found.</p>';
                return;
            }
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">¬£${product.price}</div>
                    <div class="product-category">Category: ${product.category}</div>
                    <div class="product-description">${product.description}</div>
                    <div style="margin-top: 10px; font-size: 0.8em; color: #999;">
                        SKU: ${product.sku} | Brand: ${product.brand || 'N/A'}
                    </div>
                `;
                productGrid.appendChild(productCard);
            });
        }
        
        function searchProducts() {
            const searchTerm = document.getElementById('search-input').value;
            const category = document.getElementById('category-filter').value;
            loadProducts(1, searchTerm, category);
        }
        
        // Event listeners
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });
        
        document.getElementById('category-filter').addEventListener('change', function() {
            searchProducts();
        });
        
        // Initialize
        window.onload = async function() {
            const apiConnected = await testApiConnection();
            if (apiConnected) {
                await loadCategories();
                await loadProducts();
            }
        };
    </script>
</body>
</html>
